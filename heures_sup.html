<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Heures Supplémentaires - Professeur</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background-color: #f0f0f0; }
  input, select { width: 100%; box-sizing: border-box; }
  button { padding: 6px 12px; margin-top: 5px; cursor: pointer; }
  #totalRow td { font-weight: bold; background-color: #f9f9f9; }
</style>
</head>
<body>

<h1>Déclaration Heures Supplémentaires</h1>

<table id="hsTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Type d’événement</th>
      <th>Heure début</th>
      <th>Heure fin</th>
      <th>Durée</th>
      <th>Lieu</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr id="totalRow">
      <td colspan="4">Total heures</td>
      <td id="totalDuration">0h00</td>
      <td colspan="2"></td>
    </tr>
  </tfoot>
</table>

<label>Nom complet du professeur : <input type="text" id="profName" placeholder="Ex: Sébastien GOHIER"></label>

<button id="addRowBtn">+ Ajouter une ligne</button>
<button id="sendBtn">Envoyer la demande</button>

<p id="confirmation" style="color:green; font-weight:bold;"></p>

<script>
const typesEvenement = ["Concert", "Répétition", "Autre"];

function formatDuration(hours, minutes) {
  return `${hours}h${minutes.toString().padStart(2,'0')}`;
}

function calculateDuration(start, end) {
  if (!start || !end) return "0h00";
  const [h1, m1] = start.split(":").map(Number);
  const [h2, m2] = end.split(":").map(Number);
  let totalMinutes = (h2*60 + m2) - (h1*60 + m1);
  if(totalMinutes < 0) totalMinutes = 0;
  const h = Math.floor(totalMinutes/60);
  const m = totalMinutes % 60;
  return formatDuration(h, m);
}

function updateDurations() {
  const tbody = document.querySelector("#hsTable tbody");
  let totalMinutes = 0;
  tbody.querySelectorAll("tr").forEach(tr => {
    const start = tr.querySelector(".debut").value;
    const end = tr.querySelector(".fin").value;
    const durationCell = tr.querySelector(".duree");
    const duration = calculateDuration(start, end);
    durationCell.textContent = duration;

    const [h,m] = duration.split("h").map(Number);
    totalMinutes += h*60 + m;
  });
  const hTotal = Math.floor(totalMinutes/60);
  const mTotal = totalMinutes % 60;
  document.getElementById("totalDuration").textContent = formatDuration(hTotal,mTotal);
}

function addRow(data={}) {
  const tbody = document.querySelector("#hsTable tbody");
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td><input type="date" class="date" value="${data.date || ''}"></td>
    <td>
      <select class="type">
        ${typesEvenement.map(t => `<option value="${t}" ${t===data.type?'selected':''}>${t}</option>`).join('')}
      </select>
    </td>
    <td><input type="time" class="debut" value="${data.debut || ''}"></td>
    <td><input type="time" class="fin" value="${data.fin || ''}"></td>
    <td class="duree">0h00</td>
    <td><input type="text" class="lieu" value="${data.lieu || ''}"></td>
    <td><button type="button" class="deleteBtn">X</button></td>
  `;

  tbody.appendChild(tr);

  tr.querySelector(".debut").addEventListener("input", updateDurations);
  tr.querySelector(".fin").addEventListener("input", updateDurations);
  tr.querySelector(".deleteBtn").addEventListener("click", () => {
    tr.remove();
    updateDurations();
  });

  updateDurations();
}

// Ligne initiale
addRow();

document.getElementById("addRowBtn").addEventListener("click", ()=>addRow());

document.getElementById("sendBtn").addEventListener("click", ()=>{
  const profName = document.getElementById("profName").value.trim();
  if(!profName) {
    alert("Merci d’indiquer le nom complet du professeur !");
    return;
  }

  const tbody = document.querySelector("#hsTable tbody");
  if(!tbody.querySelectorAll("tr").length){
    alert("Ajoutez au moins une ligne !");
    return;
  }

  const lignes = [];
  tbody.querySelectorAll("tr").forEach(tr => {
    lignes.push({
      date: tr.querySelector(".date").value,
      type: tr.querySelector(".type").value,
      debut: tr.querySelector(".debut").value,
      fin: tr.querySelector(".fin").value,
      duree: tr.querySelector(".duree").textContent,
      lieu: tr.querySelector(".lieu").value
    });
  });

  const total = document.getElementById("totalDuration").textContent;

  const data = {
    nomProf: profName,
    lignes: lignes,
    total: total
  };

  // --- Envoi JSON vers le Web App ---
  fetch("https://script.google.com/macros/s/AKfycby_lhPJ5cCWxe48UFdhTBbY7ievI8WS-1tj_8GF2mPvEF8HJiDPXlGCQGKQzgv7ew99/exec", {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(response => {
    if(response.status === "success"){
      document.getElementById("confirmation").textContent = response.message;
      tbody.innerHTML = "";   // reset tableau
      addRow();               // ligne initiale
      document.getElementById("profName").value = "";
    } else {
      document.getElementById("confirmation").textContent = "Erreur : " + response.message;
    }
  })
  .catch(err => {
    document.getElementById("confirmation").textContent = "Erreur : " + err;
  });
});
</script>

</body>
</html>
