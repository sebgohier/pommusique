<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Interface Professeur - POM Musique</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src https://script.google.com https://script.googleusercontent.com; img-src https://raw.githubusercontent.com 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval';">
<style>
body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; }
.sidebar { width:220px; background: linear-gradient(to bottom,#ffb629,#000000); color:white; display:flex; flex-direction:column; align-items:center; padding-top:20px; }
.sidebar img { width:150px; margin-bottom:30px; }
.menu-item { width:90%; padding:12px 10px; margin:5px 0; border-radius:8px; cursor:pointer; display:flex; align-items:center; transition: background 0.3s; font-size:16px; background-color:#ccc; color:#000; }
.menu-item:hover { background-color:#bbb; }
.menu-item span { margin-left:10px; }
.content { flex:1; padding:20px; background-color:#f9f9f9; overflow-y:auto; }
.section { display:none; }
input, select { width:100%; box-sizing:border-box; padding:4px; margin:2px 0; }
button { padding:6px 12px; margin-top:5px; cursor:pointer; }
table { border-collapse: collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #000; padding:6px; text-align:center; }
th { background-color:#f0f0f0; }
</style>
</head>
<body>

<div class="sidebar">
<img src="https://raw.githubusercontent.com/sebgohier/pommusique/refs/heads/main/Logo%20Pom%20Musique%20noir.png" alt="Logo POM Musique">
<div class="menu-item" onclick="showSection('sectionRepertoire')">üìÅ <span>R√©pertoire √©l√®ves</span></div>
<div class="menu-item" onclick="showSection('planning')">üìÖ <span>Planning</span></div>
<div class="menu-item" onclick="showSection('heuresSup')">‚è∞ <span>Heures suppl√©mentaires</span></div>
<div class="menu-item" onclick="showSection('absences')">üìù <span>Absences</span></div>
<div class="menu-item" onclick="showSection('partitions')">üéº <span>Partitions</span></div>
<div class="menu-item" onclick="showSection('contacts')">üìû <span>Contacts</span></div>
</div>

<div class="content">

<!-- Choix global du prof -->
<label for="selectProfGlobal" style="font-weight:bold;">Choisissez votre nom :</label>
<select id="selectProfGlobal" style="padding:6px; margin:8px 0; width:100%; max-width:300px; border-radius:6px; border:1px solid #ccc;">
  <option value="">-- Choisir --</option>
  <option value="Anthony">Anthony</option>
  <option value="Arnaud">Arnaud</option>
  <option value="Christian">Christian</option>
  <option value="Christelle">Christelle</option>
  <option value="Laurence">Laurence</option>
  <option value="Lor√®ne">Lor√®ne</option>
  <option value="Marion">Marion</option>
  <option value="S√©b">S√©b</option>
  <option value="Val√©rie">Val√©rie</option>
  <option value="Vincent">Vincent</option>
</select>

<!-- Section R√©pertoire √âl√®ves -->
<div id="sectionRepertoire" class="section">
  <h2>R√©pertoire √©l√®ves</h2>
  <div style="overflow-x:auto; margin-top:20px;">
    <table id="repertoireTable" style="width:100%; border-collapse: collapse; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <thead style="background: #ffb629; color:#000; text-align:left;">
        <tr>
          <th style="padding:10px;">Nom</th>
          <th style="padding:10px;">T√©l√©phone</th>
          <th style="padding:10px;">Email</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <p id="repertoireMsg" style="color:red; margin-top:10px;"></p>
</div>

<div class="section" id="planning"><h2>Planning</h2><p>Contenu...</p></div>
<div class="section" id="partitions"><h2>Partitions</h2><p>Contenu...</p></div>
<div class="section" id="contacts"><h2>Contacts</h2><p>Contenu...</p></div>

<!-- Heures Sup -->
<div class="section" id="heuresSup">
<h2>D√©claration Heures Suppl√©mentaires</h2>
<table id="hsTable">
<thead><tr><th>Date</th><th>Type</th><th>D√©but</th><th>Fin</th><th>Dur√©e</th><th>Lieu</th><th>Action</th></tr></thead>
<tbody></tbody>
<tfoot><tr><td colspan="4">Total</td><td id="totalDuration">0h00</td><td colspan="2"></td></tr></tfoot>
</table>
<button id="addRowHs">+ Ajouter une ligne</button>
<button id="sendHs">Envoyer la demande</button>
<p id="confirmHs" style="color:green;font-weight:bold;"></p>
</div>

<!-- Absences -->
<div class="section" id="absences">
<h2>Demande d'Absences</h2>
<table id="absTable">
<thead><tr>
<th>Date d'absence</th><th>Cr√©neau</th><th>Date rattrapage</th><th>Cr√©neau rattrapage</th><th>Salle</th><th>Accord</th><th>Action</th>
</tr></thead>
<tbody></tbody>
</table>
<button id="addRowAbs">+ Ajouter une ligne</button>
<button id="sendAbs">Envoyer la demande</button>
<p id="confirmAbs" style="color:green;font-weight:bold;"></p>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // --- Sections ---
  window.showSection = section => {
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(section).style.display='block';
  };

  // --- R√©pertoire ---
  const repertoireTableBody = document.querySelector("#repertoireTable tbody");
  const repertoireMsg = document.getElementById("repertoireMsg");

  function formatPhone(phone){
    phone = phone.toString().trim();
    if(!phone.startsWith("0")) phone = "0"+phone;
    return phone.replace(/(\d{2})(?=\d)/g,'$1 ');
  }

  function loadRepertoire(profName){
    repertoireTableBody.innerHTML="";
    repertoireMsg.textContent="";
    if(!profName) return;

    const url="https://script.google.com/macros/s/AKfycbwJPhDbfSOizQaWNFyib_fuR4kGZu39IDdm_mm0hSZzu8qGj5M2bwbUjiRbe_SZBiM07w/exec?profName="+encodeURIComponent(profName);

    fetch(url).then(r=>r.json()).then(data=>{
      if(data.error){ repertoireMsg.textContent=data.error; return; }
      if(data.length===0){ repertoireMsg.textContent="Aucun √©l√®ve trouv√© pour "+profName; return; }
      data.forEach((eleve,i)=>{
        const tr=document.createElement("tr");
        tr.style.backgroundColor=i%2===0?"#fff":"#f9f9f9";
        tr.innerHTML=`<td style="padding:8px;border-bottom:1px solid #ddd;">${eleve.Nom}</td>
                        <td style="padding:8px;border-bottom:1px solid #ddd;">${formatPhone(eleve.T√©l√©phone)}</td>
                        <td style="padding:8px;border-bottom:1px solid #ddd;">${eleve.Email}</td>`;
        repertoireTableBody.appendChild(tr);
      });
    }).catch(err=>repertoireMsg.textContent="Erreur lors du chargement : "+err);
  }

  document.getElementById("selectProfGlobal").addEventListener("change", e=>{
    const prof=e.target.value;
    loadRepertoire(prof);
  });

  // --- Heures Sup ---
  const typesEvenement = ["Concert","R√©p√©tition","Autre"];
  function formatDuration(h,m){ return `${h}h${m.toString().padStart(2,'0')}`; }
  function calculateDuration(start,end){
    if(!start||!end) return "0h00";
    const [h1,m1]=start.split(":").map(Number);
    const [h2,m2]=end.split(":").map(Number);
    let total=(h2*60+m2)-(h1*60+m1); if(total<0) total=0;
    return formatDuration(Math.floor(total/60), total%60);
  }
  function updateDurHs(){
    let totalMins=0;
    document.querySelectorAll("#hsTable tbody tr").forEach(tr=>{
      const start=tr.querySelector(".debut").value;
      const end=tr.querySelector(".fin").value;
      const dur=calculateDuration(start,end);
      tr.querySelector(".duree").textContent=dur;
      const [h,m]=dur.split("h").map(Number);
      totalMins+=h*60+m;
    });
    document.getElementById("totalDuration").textContent=formatDuration(Math.floor(totalMins/60), totalMins%60);
  }
  function addRowHs(data={}){ 
    const tbody=document.querySelector("#hsTable tbody"); 
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input type="date" class="date" value="${data.date||''}"></td>
      <td><select class="type">${typesEvenement.map(t=>`<option value="${t}" ${t===data.type?'selected':''}>${t}</option>`).join('')}</select></td>
      <td><input type="time" class="debut" value="${data.debut||''}"></td>
      <td><input type="time" class="fin" value="${data.fin||''}"></td>
      <td class="duree">0h00</td>
      <td><input type="text" class="lieu" value="${data.lieu||''}"></td>
      <td><button type="button" class="deleteBtn">X</button></td>`;
    tbody.appendChild(tr);
    tr.querySelector(".debut").addEventListener("input",updateDurHs);
    tr.querySelector(".fin").addEventListener("input",updateDurHs);
    tr.querySelector(".deleteBtn").addEventListener("click",()=>{tr.remove(); updateDurHs();});
    updateDurHs();
  }
  document.getElementById("addRowHs").addEventListener("click",()=>addRowHs());
  addRowHs(); // premi√®re ligne

  document.getElementById("sendHs").addEventListener("click", ()=>{
    const nomProfHs = document.getElementById("selectProfGlobal").value.trim();
    if(!nomProfHs){ alert("Indiquez le nom du professeur !"); return; }
    const tbody=document.querySelector("#hsTable tbody"); 
    const lignes=[];
    tbody.querySelectorAll("tr").forEach(tr=>{
      lignes.push({
        date: tr.querySelector(".date").value,
        type: tr.querySelector(".type").value,
        debut: tr.querySelector(".debut").value,
        fin: tr.querySelector(".fin").value,
        duree: tr.querySelector(".duree").textContent,
        lieu: tr.querySelector(".lieu").value
      });
    });
    const total=document.getElementById("totalDuration").textContent;
    fetch("https://script.google.com/macros/s/AKfycbyoEkd0NtmfVYRaSujaVeM_wfiEbZCjfJgzTLuKx4a8SJgD47dh9zWGfOR8crss2fk9/exec",{method:"POST",body:JSON.stringify({nomProf:nomProfHs,lignes,total})})
      .then(res=>res.json()).then(res=>{
        document.getElementById("confirmHs").textContent=res.message;
        tbody.innerHTML=""; addRowHs();
      }).catch(err=>{ document.getElementById("confirmHs").textContent="Erreur : "+err; });
  });

  // --- Absences ---
  const salles = ["FM/Piano","Guitare","Batterie","Piano 2","Artistes","Salle des f√™tes Moult"];
  function addRowAbs(data={}){
    const tbody=document.querySelector("#absTable tbody"); 
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input type="date" class="dateAbs" value="${data.dateAbs||''}"></td>
      <td><input type="text" class="creneauAbs" placeholder="Ex: 16h30-18h30" value="${data.creneauAbs||''}"></td>
      <td><input type="date" class="dateRatt" value="${data.dateRatt||''}"></td>
      <td><input type="text" class="creneauRatt" placeholder="Ex: 16h30-18h30" value="${data.creneauRatt||''}"></td>
      <td><select class="salle">${salles.map(s=>`<option value="${s}" ${s===data.salle?'selected':''}>${s}</option>`).join('')}</select></td>
      <td><input type="checkbox" class="accord" ${data.accord?'checked':''}></td>
      <td><button type="button" class="deleteBtn">X</button></td>`;
    tbody.appendChild(tr);
    tr.querySelector(".deleteBtn").addEventListener("click",()=>tr.remove());
  }
  document.getElementById("addRowAbs").addEventListener("click",()=>addRowAbs());
  addRowAbs(); // premi√®re ligne

  document.getElementById("sendAbs").addEventListener("click", ()=>{
    const nomProfAbs = document.getElementById("selectProfGlobal").value.trim();
    if(!nomProfAbs){ alert("Indiquez le nom du professeur !"); return; }
    const tbody=document.querySelector("#absTable tbody"); 
    const lignes=[];
    tbody.querySelectorAll("tr").forEach(tr=>{
      lignes.push({
        dateAbs: tr.querySelector(".dateAbs")?.value || "",
        creneauAbs: tr.querySelector(".creneauAbs")?.value || "",
        dateRatt: tr.querySelector(".dateRatt")?.value || "",
        creneauRatt: tr.querySelector(".creneauRatt")?.value || "",
        salle: tr.querySelector(".salle")?.value || "",
        accord: tr.querySelector(".accord")?.checked || false
      });
    });
    fetch("https://script.google.com/macros/s/AKfycbxB4nTAyo-dbK89U1UNGkCp9n_vwBf5MDln9s2-dVPW6Qh4X2HNcp6fXttJFuxpOMD0/exec",{
      method:"POST",
      body: JSON.stringify({nomProf:nomProfAbs,lignes})
    })
    .then(res=>res.json())
    .then(res=>{
      document.getElementById("confirmAbs").textContent=res.message || "PDF envoy√© avec succ√®s";
      tbody.innerHTML=""; addRowAbs();
    }).catch(err=>{
      document.getElementById("confirmAbs").textContent="Erreur : "+err;
    });
  });

});
</script>
</body>
</html>
